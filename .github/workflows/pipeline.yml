name: Package publish

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  assembly: "Microsoft.DigitalWorkplace.DigitalTwins.QueryBuilder"

jobs:
  Parse_Environment:
    runs-on: ubuntu-latest
    outputs:
      assembly_name: ${{steps.parse.outputs.assembly_name}}
    steps:
      - name: Parse Environment
        id: parse
        run: echo "::set-output name=assembly_name::${{env.assembly}}"

  Build:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/build.yml@a7312c32ee4d2495a44b4bd518efa0275b97dbde
    needs: Parse_Environment
    with:
      project-to-pack: "QueryBuilder/QueryBuilder.csproj"

  Sign:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/sign.yml@cd6efdfc176d782f5caf7ace270265e020c7894f
##     if: github.event.push
    needs: [Parse_Environment, Build]
    with:
      assembly_name: ${{ needs.Parse_Environment.outputs.assembly_name }}
      beta_version: ${{ needs.Build.outputs.beta-version }}
      stable_version: ${{ needs.Build.outputs.stable-version }}
    secrets:
      client_id: ${{ secrets.AAD_SIGNING_CLIENT_ID }}
      az_creds: ${{ secrets.AZURE_CREDENTIALS }}
      az_sub: ${{ secrets.AZURE_SUBSCRIPTION }}
      storage_name: ${{ secrets.AZURE_STORAGE }}
      container_name: ${{ secrets.AZURE_STORAGE_CONTAINER }}
      vault_name: ${{ secrets.AZURE_VAULT }}
      aad_cert: ${{ secrets.AAD_AUTH_CERT }}
      sign_cert: ${{ secrets.ESRP_SIGNING_CERT }}
      
  Publish_Beta:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/beta_publish.yml@6ef14f2a6912cbe25df8d2a7ae674577cf7bb7f4
    needs: [Parse_Environment, Build, Sign]
    with:
      assembly_name: ${{ needs.Parse_Environment.outputs.assembly_name }}
      version: ${{ needs.Build.outputs.beta-version }}
    secrets:
      api_key: ${{ secrets.NUGET_API_KEY }}

  Publish_Stable:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/stable_publish.yml@6ee20cc25d3da44167ed65ad599667eaff93349b
    needs: [Parse_Environment, Build, Sign]
    with:
      assembly_name: ${{ needs.Parse_Environment.outputs.assembly_name }}
      version: ${{ needs.Build.outputs.stable-version }}
    secrets:
      api_key: ${{ secrets.NUGET_API_KEY }}
