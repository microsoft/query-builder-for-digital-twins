name: Package publish

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  Build:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/build.yml@main
    with:
      project-to-pack: "QueryBuilder/QueryBuilder.csproj"

  Sign:
    runs-on: windows-latest
    environment: Sign
    needs: Build
    steps:
    - name: Download unsigned packages
      uses: actions/download-artifact@v2
      with:
        name: unsigned
        path: unsigned

    - name: Create signed directory
      run: |
        mkdir signed/beta
        mkdir signed/stable

    - name: Create Auth file
      env: 
        APP_ID: ${{ secrets.AAD_SIGNING_CLIENT_ID }}
      run: |
        $authJson = @'
        {
          "Version": "1.0.0",
          "AuthenticationType": "AAD_CERT",
          "TenantId": "72f988bf-86f1-41af-91ab-2d7cd011db47",
          "ClientId": "${{env.APP_ID}}",
          "AuthCert": {
            "SubjectName": "CN=${{env.APP_ID}}.microsoft.com",
            "StoreLocation": "LocalMachine",
            "StoreName": "My",
            "SendX5c": "true"
          },
          "RequestSigningCert": {
            "SubjectName": "CN=${{env.APP_ID}}",
            "StoreLocation": "LocalMachine",
            "StoreName": "My"
          }
        }
        '@
        Out-File -FilePath .\auth.json -InputObject $authJson

    - name: Create Beta Input file
      run: |
        $betaInputJsonTemplate = @'
        {
          "Version": "1.0.0",
          "SignBatches": [
            {
              "SourceLocationType": "UNC",
              "SourceRootDirectory": "@@workspace@@\\unsigned\\beta",
              "DestinationLocationType": "UNC",
              "DestinationRootDirectory": "@@workspace@@\\signed\\beta",
              "SignRequestFiles": [
                {
                  "SourceLocation": "Microsoft.DigitalWorkplace.DigitalTwins.QueryBuilder.${{needs.Build.outputs.beta-version}}.nupkg",
                  "DestinationLocation": "Microsoft.DigitalWorkplace.DigitalTwins.QueryBuilder.${{needs.Build.outputs.beta-version}}.nupkg"
                }
              ],
              "SigningInfo": {
                "Operations": [
                  {
                    "KeyCode": "CP-401405",
                    "OperationCode": "NuGetSign",
                    "ToolName": "sign",
                    "ToolVersion": "1.0"
                  },
                  {
                  "KeyCode": "CP-401405",
                    "OperationCode": "NuGetVerify",
                    "ToolName": "sign",
                    "ToolVersion": "1.0"
                  }
                ]
              }
            }
          ]
        }
        '@
        $workspace = [regex]::escape("${{github.workspace}}")
        $betaInputJson = $betaInputJsonTemplate -replace '@@workspace@@', $workspace
        Out-File -FilePath .\betaInput.json -InputObject $betaInputJson

    - name: Create Stable Input file
      env: 
        APP_ID: ${{ secrets.AAD_SIGNING_CLIENT_ID }}
      run: |
        $stableInputJsonTemplate = @'
        {
          "Version": "1.0.0",
          "SignBatches": [
            {
              "SourceLocationType": "UNC",
              "SourceRootDirectory": "@@workspace@@\\unsigned\\stable",
              "DestinationLocationType": "UNC",
              "DestinationRootDirectory": "@@workspace@@\\signed\\stable",
              "SignRequestFiles": [
                {
                  "SourceLocation": "Microsoft.DigitalWorkplace.DigitalTwins.QueryBuilder.${{needs.Build.outputs.stable-version}}.nupkg",
                  "DestinationLocation": "Microsoft.DigitalWorkplace.DigitalTwins.QueryBuilder.${{needs.Build.outputs.stable-version}}.nupkg"
                }
              ],
              "SigningInfo": {
                "Operations": [
                  {
                    "KeyCode": "CP-401405",
                    "OperationCode": "NuGetSign",
                    "ToolName": "sign",
                    "ToolVersion": "1.0"
                  },
                  {
                  "KeyCode": "CP-401405",
                    "OperationCode": "NuGetVerify",
                    "ToolName": "sign",
                    "ToolVersion": "1.0"
                  }
                ]
              }
            }
          ]
        }
        '@
        $workspace = [regex]::escape("${{github.workspace}}")
        $stableInputJson = $stableInputJsonTemplate -replace '@@workspace@@', $workspace
        Out-File -FilePath .\stableInput.json -InputObject $stableInputJson

    - uses: azure/login@v1
      name: Azure Login
      with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install ESRP Client
      run: |
        az storage blob download --auth-mode login --subscription  ${{ secrets.AZURE_SUBSCRIPTION }} --account-name wlpistorageaccount -c esrp-client -n microsoft.esrpclient.1.2.76.zip -f esrp.zip
        unzip -d ./esrp esrp.zip

    - name: Install Certificates
      env:
        AZ_SUB: ${{ secrets.AZURE_SUBSCRIPTION }}
        AZ_VAULT: ${{ secrets.AZURE_VAULT }}
        AAD_CERT: ${{ secrets.AAD_AUTH_CERT }}
        ESRP_CERT: ${{ secrets.ESRP_SIGNING_CERT }}
      run: |
        az keyvault secret download --subscription "${{env.AZ_SUB}}" --vault-name "${{env.AZ_VAULT}}" --name "${{env.AAD_CERT}}" -f cert.pfx
        certutil -silent -f -importpfx cert.pfx
        rm cert.pfx
        az keyvault secret download --subscription "${{env.AZ_SUB}}" --vault-name "${{env.AZ_VAULT}}" --name "${{env.ESRP_CERT}}" -f cert.pfx
        certutil -silent -f -importpfx cert.pfx
        rm cert.pfx

    - name: Run ESRP Client
      run: |
        ./esrp/tools/EsrpClient.exe sign -a ./auth.json -p ./esrp/tools/Policy.json -c ./esrp/tools/Config.json -i ./betaInput.json -o ./Output.json -l Verbose -f STDOUT
        ./esrp/tools/EsrpClient.exe sign -a ./auth.json -p ./esrp/tools/Policy.json -c ./esrp/tools/Config.json -i ./stableInput.json -o ./Output.json -l Verbose -f STDOUT

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5
        
    - name: Verify Signature
      run: |
        nuget.exe verify -Signatures signed/stable/Microsoft.DigitalWorkplace.DigitalTwins.QueryBuilder.${{needs.Build.outputs.stable-version}}.nupkg
        nuget.exe verify -Signatures signed/beta/Microsoft.DigitalWorkplace.DigitalTwins.QueryBuilder.${{needs.Build.outputs.beta-version}}.nupkg

    - name: Publish Signed
      uses: actions/upload-artifact@v2
      with:
        name: signed
        path: signed

    - name: Azure logout
      run: az logout
      if: always()
