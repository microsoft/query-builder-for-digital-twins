name: Package publish

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  assembly_name: "Microsoft.DigitalWorkplace.DigitalTwins.QueryBuilder"

jobs:
  Build:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/build.yml@a7312c32ee4d2495a44b4bd518efa0275b97dbde
    with:
      project-to-pack: "QueryBuilder/QueryBuilder.csproj"

  Sign:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/sign.yml@2576f10f6a1584ae6872245ccbf0a5318a37ff66
#     if: github.event.push
    needs: Build
    with:
      assembly_name: ${{ env.assembly_name }}
      beta_version: ${{ needs.Build.outputs.beta-version }}
      stable_version: ${{ needs.Build.outputs.stable-version }}
    secrets:
      client_id: ${{ secrets.AAD_SIGNING_CLIENT_ID }}
      az_creds: ${{ secrets.AZURE_CREDENTIALS }}
      az_sub: ${{ secrets.AZURE_SUBSCRIPTION }}
      storage_name: ${{ secrets.AZURE_STORAGE }}
      container_name: ${{ secrets.AZURE_STORAGE_CONTAINER }}
      vault_name: ${{ secrets.AZURE_VAULT }}
      aad_cert: ${{ secrets.AAD_AUTH_CERT }}
      sign_cert: ${{ secrets.ESRP_SIGNING_CERT }}
      
  Publish_Beta:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/beta_publish.yml@cd6efdfc176d782f5caf7ace270265e020c7894f
    needs: [Build, Sign]
    with:
      assembly_name: ${{ env.assembly_name }}
      version: ${{ needs.Build.outputs.beta-version }}
    secrets:
      api_key: ${{ secrets.NUGET_API_KEY }}

  Publish_Stable:
    uses: microsoft/query-builder-for-digital-twins/.github/workflows/stable_publish.yml@6ee20cc25d3da44167ed65ad599667eaff93349b
    needs: [Build, Sign]
    with:
      assembly_name: ${{ env.assembly_name }}
      version: ${{ needs.Build.outputs.stable-version }}
    secrets:
      api_key: ${{ secrets.NUGET_API_KEY }}
